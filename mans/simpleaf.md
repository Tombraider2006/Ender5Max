
## Установка прошивки Simple Af Ender 5 Max

### Почему Simple AF

Данная модификация призвана решить несколько проблем существующих на стоковой прошивке и не устранимых даже с модификациями Helper Script.

Долгий старт и долгое, неточное тестирование первоначальный тест Z оси, очистка сопла, "круг почета" тестирования тензодатчиков. В прошивке Simple Af родные тензодатчики не задействованы вместо них предлагается использовать альтернативы.

Отсутсвие алгоритма KAMP в стоковой прошивке изза чего стол тестируется долго, неточно, и не только где нам надо, а везде.

Осталость от современных тенденций развития алгоритмов Алгоритм input shaping, adaptive mesh, и еще многое получило свое развитие, в отличии от прошивки которая находится в том же состоянии что и несколько лет! назад. Косметические улучшения не устранили отставание, а где то и привнесли новые проблемы например жесткая привязка к Creality Print после прошивки 1.2.0.20

Всё это мы вынуждены терпеть из-за выбора компанией Creality собственного пути развития датчиков оси Z который разошелся с основной веткой klipper.

Немного с сайта прошивки о плюсах данного решения.

*Открытый исходный код Simple AF использует программное обеспечение с открытым исходным кодом, и весь его исходный код открыт.*

*Простая конфигурация Все макросы и конфигурации находятся в каталоге config и доступны вам, ничего не заперто в закрытых исходных кодах.*

*Обновленный Клиппер Используемая нами версия klipper, хотя и является ответвлением от основной версии, регулярно обновляется с помощью klipper3d, и никакие наши добавления не меняют базовое поведение klipper.*

Основная проблема в том что обновленный klipper прошивки не может использовать родные тензодатчики стола. от них придется отказаться и одним из самых продвинутых вариантов является картографер с которым мы и будем дружить наш принтер. Для начала нам необходимо получить доступ к консоли линукс и для этого нам необходимо установить предустановленную прошивку от [zevaryx](/firmware.md) что даст нам возможность зайти по ssh с правами root.

Далее нам надо подготовить печатные детали креплений датчика картографер и экрана:

### Варианты креплений датчика

| Модель       | Тип             | Ссылка                                                                 | Примечания                          |
|--------------|-----------------|-----------------------------------------------------------------------|-------------------------------------|
| SimplyHexed  | Прямой угол 90    | [Printables](https://www.printables.com/model/1209230-ender-5-max-simply-hexed)                              | Только для Ender 5 Max              |


Если меняли хотенд на к2 то необходим [корпус обдува уменьшенный по высоте на 2 мм](/files/front_cover_carto.stl) 

### Крепление экрана

Так как в прошивке SimpleAF используется горизонтальное положение экрана используем [**такую**](/files/Ender5MaxScreenMount.stl) модель крепления.

### Прошивка датчика

На датчике должна быть установлена прошивка не старше `CARTOGRAPHER K1 5.1.0` : 

[**Инструкции по прошивке датчика**](https://pellcorp.github.io/creality-wiki/cartographer_flashing/#flashing-k1-firmware-via-dfu-mode)

[**Инструкции по прошивке датчика в среде windows**](/mans/dfu.md)


### Подготовка и прошивка.

Чтобы убедится что нам ничто не помешает и не останется ничего лишнего сбросим прошивку до заводских однако сохраняя доступ и настройки wifi для этого скопируйте данны код и вставьте в консоль:

```
wget --no-check-certificate https://raw.githubusercontent.com/pellcorp/creality/main/k1/services/S58factoryreset -O /tmp/S58factoryreset
chmod +x /tmp/S58factoryreset
/tmp/S58factoryreset reset

```
Очень важно не закрывать сеанс SSH, пока не получите следующее сообщение:

`Info: Executing factory reset... Info: Factory reset was executed successfully, the printer will restart...`

принтер перезагрузится и можно переоткрыть консоль ssh.

### Важно! проверьте дату на принтере.

```
date
```
если отличается от текущей 

```
hwclock -w
```
и еще раз проверяем


```
date
```
**вариант номер 2.**

 просто выставьте текущий часовой пояс на принтере.

если этого не сделать то будет ошибка в сертификатах и модули установочные не загрузятся.


Далее клонируем репозиторий с прошивкой:

```
git config --global http.sslVerify false
git clone https://github.com/pellcorp/creality.git /usr/data/pellcorp
sync

```

### Запускаем установщик

```
/usr/data/pellcorp/k1/installer.sh --install cartotouch --mount SimplyHexed

```

установка займет какое то время. 

### После установки

Возможное обновления прошивки MCU

Если в конце процесса установки вы получите следующее сообщение:

`WARNING: MCU Firmware updates are pending you need to power cycle your printer!`

Это означает, что необходимо применить новые обновления прошивки MCU, и это можно сделать только путем выключения и повторного включения принтера. После выключения и повторного включения принтера вы можете проверить, была ли обновлена ​​прошивка с помощью `CHECK_FIRMWARE` макроса из Fluidd, если вы видите это сообщение: `INFO: Your MCU Firmware is up to date` значит все нормально.

После прошивки на экране принтера будет запрос на калибровку экрана. не игнорируйте его.

### Калибровка

Для настройки нового принтера необходимо выполнить три различных шага калибровки:

<details><summary>Ручная калибровка картографа</summary>

Следующие команды вводим в консоли вебпанели.

1. Делаем хоум осей икс игрек  XY  `G28 X Y`
2. Нагрейте сопло до 150 °C  `M109 S150`.
3. Убедитесь, что сопло расположено по центру кровати.
4. Выполните  `CARTOGRAPHER_CALIBRATE METHOD=manual` бумажный тест. Не используйте металлический щуп на этом этапе, он может помешать калибровке!!!
5. После окончания нажмем сохранить перегрузить или введем в панели `SAVE_CONFIG` </details>

<details><summary>Картографическое пороговое сканирование</summary>

**На этом следующем этапе очень важно находиться рядом с принтером, поскольку если возникнут какие-либо проблемы с конфигурацией принтера или зондом картриджа, сопло может застрять в платформе, поэтому держите руку над кнопкой аварийной остановки!**

Следующие команды вводим в консоли вебпанели.

1. Делаем хоум Всех осей `G28`
2. Убедитесь, что сопло расположено по центру кровати.
3. Нагрейте сопло до 150 °C `M109 S150`
4. Выполнить `CARTOGRAPHER_THRESHOLD_SCAN SPEED=2 MIN=1500 MAX=5000`
5. по завершении `SAVE_CONFIG`
</details>

<details><summary>Калибровка сенсорного датчика Cartographer</summary>

Следующие команды вводим в консоли вебпанели.

1. Делаем хоум Всех осей `G28`
2. Нагрейте сопло до 150 °C `M109 S150`
3. Выполнить `CARTOGRAPHER_CALIBRATE`
4. по завершении `SAVE_CONFIG`
</details>

В родном мануале далее рекомендуется выполнить калибровку компенсации скручивания оси, но так как у нас в креплении нет сдвига по обоим осям нам это необязательно. 

если ваша карта стола выглядит так:

![](/images/map_carto.png)

то вы забыли прошить сам картографер и вам придется всю настройку повторить заново после прошивки.

 Если вы запускаете калибровку для принтера, который был откалиброван ранее, перед повторным выполнением этих калибровок необходимо удалить следующие разделы SAVE_CONFIG :
```
[scanner model default]
[scanner]
[axis_twist_compensation]
[bed_mesh]

```




### Наладка прошивки.

Для начала сделаем несколько тестов и калибровок.

Следующие команды вводим в консоли вебпанели.

```
PID_CALIBRATE_BED BED_TEMP=65
PID_CALIBRATE_HOTEND HOTEND_TEMP=230
INPUT_SHAPER
SAVE_CONFIG
```

`PID_CALIBRATE_HOTEND HOTEND_TEMP=230` и `PID_CALIBRATE_BED BED_TEMP=65` это процедура калибровки, которая гарантирует, что принтер всегда будет поддерживать стабильную заданную температуру . PID (пропорционально-интегральная производная) используется в принтерах для поддержания стабильной температуры в хотенде и\или нагреваемом столе.

`INPUT_SHAPER` делает тест резонансов и записывает результат в `printer.cfg`

по завершении `SAVE_CONFIG` сохранит все наши данные в файле `printer.cfg` и перезапустит принтер. 

Также можно запустить `INPUT_SHAPER_GRAPHS` чтобы посмотреть графики резонансов. после теста они появятся в корневой папке конфигов.  

`BELTS_SHAPER_CALIBRATION` делает тест резонансов и создает график натяжения ремней.

## Правка начального и конечного кода слайсера.

В современных принтерах давно ушли от начальных g-code в слайсере и применяются макросы которые на старте печати сверяясь с различными условиями гораздо эффективнее подготавливают принтер к печати. чтобы пользоваться этими современными методами в нашей прошивке достаточно поставить правильные стартовый и конечный код в слайсере. 

так как мы используем откат из прошивки нам необходимо подправить несколько пунктов:

![](/images/orca1.png)

![](/images/orca2.png)

стартовый код для **OrcaSliser**:

```
M140 S0
M104 S0
START_PRINT EXTRUDER_TEMP=[nozzle_temperature_initial_layer] BED_TEMP=[bed_temperature_initial_layer_single]
SET_RETRACTION RETRACT_LENGTH=[retraction_length] RETRACT_SPEED=[retraction_speed] UNRETRACT_EXTRA_LENGTH=[retract_restart_extra] UNRETRACT_SPEED=[deretraction_speed]
RESPOND TYPE=command MSG="Retraction length set to [retraction_length]mm" 
RESPOND TYPE=command MSG="Retract speed set to [retraction_speed]/[deretraction_speed]mm/c"

```

конечный код для **OrcaSliser**:

```
END_PRINT

```

### вы купили зашивку корпуса и теперь провода мешают открывать дверцу.

![](/images/door_lock_screen.png)

Для этого надо поменять ориентацию в файле /usr/data/guppyscreen/guppyscreen.json на 0 и убрать данные о калибровке. 

Перед внесением измененний сделайте резервную копию своего файла!

<details><summary>Вариант №1</summary>

`"display_rotate": 2,` - находим строку и меняем на 0 значение.


`"touch_calibration_coeff"` и удаляем его и все данные за ним до следующего параметра.

перезагружаемся и выполняем калибровку экрана 

</details>

<details><summary>Вариант №2 простой</summary>

В консоль ssh копируем следующие команды. 

```
cd /usr/data/guppyscreen/
mv guppyscreen.json guppyscreen.json.bak
wget -P /usr/data/guppyscreen/ https://raw.githubusercontent.com/Tombraider2006/Ender5Max/refs/heads/main/files/guppyscreen.json
chmod 644 guppyscreen.json

```
Пояснения к командам:

`cd /usr/data/guppyscreen/` переходим в нужный каталог.

`mv guppyscreen.json guppyscreen.json.bak` делаем бекап нашего файла.

`wget -P /usr/data/guppyscreen/ и тд` скачиваем в каталог файл преднастроенный.

`chmod 644 guppyscreen.json` выдаем права на чтение и запись.

**Перезагружаемся и проводим калибровку экрана.**
</details>

![](/images/door_unlock_screen.png)


Вы можете обратиться ко мне за [**консультацией**](/kurs.md). и я помогу с установкой програмного обеспечения.

## Разное полезное

чтобы принтер не шумел обдувом материнской платы при простое.

в файле `fan_control.cfg` **надо заменить** раздел `controller_fan`. старый стираем этот вставляем.

```
[controller_fan MCU_fan] # включаем обдув после включения драйверов
pin: PB1
max_power: 1.0
fan_speed: 1
kick_start_time: 0
stepper: stepper_x

```

в файле `start_end.cfg` ищем макрос `[gcode_macro _CLIENT_VARIABLE]`

в нем в строке меняем 25 на 380чтобы стол отьезжал ниже. *полезно тем у кого принтер стоит выше чем на полу*

```
variable_custom_park_dz: 380.0 # положение стола после печати
```
по просьбам еще немного перевода из макроса `[gcode_macro _CLIENT_VARIABLE]`


```
[gcode_macro _CLIENT_VARIABLE]
variable_park_at_cancel: True # не трогаем
variable_use_custom_pos: True # не трогаем
variable_custom_park_dz: 380.0 # позиция по Z при отмене или завершении печати
variable_park_at_cancel_x: 396 # позиция по X при отмене или завершении печати
variable_park_at_cancel_y: 391 # позиция по Y при отмене или завершении печати
variable_cancel_retract: 7.0 # втягивание филамента при отмене или завершении печати
variable_custom_park_x: 300 # позиция по X при паузе, смене филамента или его окончании
variable_custom_park_y: 9 # позиция по Y при паузе, смене филамента или его окончании
variable_retract: 1.0 # значения ретракта по умолчанию
variable_speed_retract: 35.0 # скорость ретракта в мм/с
variable_unretract: 1.0 # скорость возврата филамента в мм/с
variable_speed_unretract: 35.0 # скорость возврата подачи филамента в мм/с
variable_speed_hop: 15.0 # скорость движения по оси Z в мм/с
variable_speed_move: 100.0 # скорость перемещения в мм/с
variable_user_cancel_macro: "_ON_CANCEL" # не изменять — отвечает за отмену печати
variable_user_resume_macro: "_ON_RESUME" # не изменять — отвечает за возобновление после паузы
variable_user_pause_macro: "_ON_PAUSE" # не изменять — отвечает за выполнение пользовательского кода при паузе

```

если не хочется ждать стабилизации температуры перед печатью ставим 0 в следующем макросе:

```
[output_pin Bed_Warp_Stabilisation]
pin: virtual_pin:BED_WARP_STABILISE_pin
value: 0
```