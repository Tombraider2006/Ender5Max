
## Установка прошивки Simple Af Ender 5 Max

Основная проблема в том что обновленный klipper прошивки не может использовать родные тензодатчики стола. от них придется отказаться и одним из самых продвинутых вариантов является картографер с которым мы и будем дружить наш принтер. для начала нам необходимо получить доступ к консоли линукс и для этого нам необходимо установить предустановленную прошивку от [zevaryx](/firmware.md) что даст нам возможность зайти по ssh с правами root.

Далее нам надо подготовить печатные детали креплений датчика картографер и экрана:

### Варианты креплений датчика

| Модель       | Тип             | Ссылка                                                                 | Примечания                          |
|--------------|-----------------|-----------------------------------------------------------------------|-------------------------------------|
| SimplyHexed  | Прямой угол     | [Printables](https://www.printables.com/model/1209230-ender-5-max-simply-hexed)                              | Только для Ender 5 Max              |

### Крепление экрана

Так как в прошивке SimpleAF используется горизонтальное положение экрана используем [**такую**](/files/Ender5MaxScreenMount.stl) модель крепления.

### Прошивка датчика

На датчике должна быть установлена прошивка не старше `CARTOGRAPHER K1 5.1.0` : 

[**Инструкции по прошивке датчика**](https://pellcorp.github.io/creality-wiki/cartographer_flashing/#flashing-k1-firmware-via-dfu-mode)



### Подготовка и прошивка.

Чтобы убедится что нам ничто не помешает и не останется ничего лишнего сбросим прошивку до заводских однако сохраняя доступ и настройки wifi для этого скопируйте данны код и вставьте в консоль:

```
wget --no-check-certificate https://raw.githubusercontent.com/pellcorp/creality/main/k1/services/S58factoryreset -O /tmp/S58factoryreset
chmod +x /tmp/S58factoryreset
/tmp/S58factoryreset reset

```
Очень важно не закрывать сеанс SSH, пока не получите следующее сообщение:

`Info: Executing factory reset... Info: Factory reset was executed successfully, the printer will restart...`

принтер перезагрузится и можно переоткрыть консоль ssh.

Далее клонируем репозиторий с прошивкой:

```
git config --global http.sslVerify false
git clone https://github.com/pellcorp/creality.git /usr/data/pellcorp
sync

```

### Запускаем установщик

```
/usr/data/pellcorp/k1/installer.sh --install cartotouch --mount Mount SimplyHexed

```

установка займет какое то время. 

### После установки

Возможное обновления прошивки MCU

Если в конце процесса установки вы получите следующее сообщение:

`WARNING: MCU Firmware updates are pending you need to power cycle your printer!`

Это означает, что необходимо применить новые обновления прошивки MCU, и это можно сделать только путем выключения и повторного включения принтера. После выключения и повторного включения принтера вы можете проверить, была ли обновлена ​​прошивка с помощью `CHECK_FIRMWARE` макроса из Fluidd, если вы видите это сообщение: `INFO: Your MCU Firmware is up to date` значит все нормально.

После прошивки на экране принтера будет запрос на калибровку экрана. не игнорируйте его.

### Калибровка

Для настройки нового принтера необходимо выполнить три различных шага калибровки:

<details><summary>Ручная калибровка картографа</summary>

Следующие команды вводим в консоли вебпанели.

1. Делаем хоум осей икс игрек  XY  `G28 X Y`
2. Нагрейте сопло до 150 °C  `M109 S150`.
3. Убедитесь, что сопло расположено по центру кровати.
4. Выполните  `CARTOGRAPHER_CALIBRATE METHOD=manual` бумажный тест. Не используйте металлический щуп на этом этапе, он может помешать калибровке!!!
5. После окончания нажмем сохранить перегрузить или введем в панели `SAVE_CONFIG` </details>

<details><summary>Картографическое пороговое сканирование</summary>

**На этом следующем этапе очень важно находиться рядом с принтером, поскольку если возникнут какие-либо проблемы с конфигурацией принтера или зондом картриджа, сопло может застрять в платформе, поэтому держите руку над кнопкой аварийной остановки!**

Следующие команды вводим в консоли вебпанели.

1. Делаем хоум Всех осей `G28`
2. Убедитесь, что сопло расположено по центру кровати.
3. Нагрейте сопло до 150 °C `M109 S150`
4. Выполнить `CARTOGRAPHER_THRESHOLD_SCAN SPEED=2 MIN=1500 MAX=5000`
5. по завершении `SAVE_CONFIG`
</details>

<details><summary>Калибровка сенсорного датчика Cartographer</summary>

Следующие команды вводим в консоли вебпанели.

1. Делаем хоум Всех осей `G28`
2. Нагрейте сопло до 150 °C `M109 S150`
3. Выполнить `CARTOGRAPHER_CALIBRATE`
4. по завершении `SAVE_CONFIG`
</details>

В родном мануале далее рекомендуется выполнить калибровку компенсации скручивания оси, но так как у нас в креплении нет сдвига по обоим осям нам это необязательно. 

если ваша карта стола выглядит так:

![](/images/map_carto.png)

то вы забыли прошить сам картографер и вам придется всю настройку повторить заново после прошивки.

 Если вы запускаете калибровку для принтера, который был откалиброван ранее, перед повторным выполнением этих калибровок необходимо удалить следующие разделы SAVE_CONFIG :
```
[scanner model default]
[scanner]
[axis_twist_compensation]
[bed_mesh]

```




### Наладка прошивки.

Для начала сделаем несколько тестов и калибровок.

Следующие команды вводим в консоли вебпанели.

```
PID_CALIBRATE_BED BED_TEMP=65
PID_CALIBRATE_HOTEND HOTEND_TEMP=230
INPUT_SHAPER
SAVE_CONFIG
```

`PID_CALIBRATE_HOTEND HOTEND_TEMP=230` и `PID_CALIBRATE_BED BED_TEMP=65` это процедура калибровки, которая гарантирует, что принтер всегда будет поддерживать стабильную заданную температуру . PID (пропорционально-интегральная производная) используется в принтерах для поддержания стабильной температуры в хотенде и\или нагреваемом столе.

`INPUT_SHAPER` делает тест резонансов и записывает результат в `printer.cfg`

по завершении `SAVE_CONFIG` сохранит все наши данные в файле `printer.cfg` и перезапустит принтер. 

Также можно запустить `INPUT_SHAPER_GRAPHS` чтобы посмотреть графики резонансов. после теста они появятся в корневой папке конфигов.  

`BELTS_SHAPER_CALIBRATION` делает тест резонансов и создает график натяжения ремней.

## Правка начального и конечного кода слайсера.

В современных принтерах давно ушли от начальных g-code в слайсере и применяются макросы которые на старте печати сверяясь с различными условиями гораздо эффективнее подготавливают принтер к печати. чтобы пользоваться этими современными методами в нашей прошивке достаточно поставить правильные стартовый и конечный код в слайсере. 

так как мы используем откат из прошивки нам необходимо подправить несколько пунктов:

![](/images/orca1.png)

![](/images/orca2.png)

стартовый код для **OrcaSliser**:

```
M140 S0
M104 S0
START_PRINT EXTRUDER_TEMP=[nozzle_temperature_initial_layer] BED_TEMP=[bed_temperature_initial_layer_single]
SET_RETRACTION RETRACT_LENGTH=[retraction_length] RETRACT_SPEED=[retraction_speed] UNRETRACT_EXTRA_LENGTH=[retract_restart_extra] UNRETRACT_SPEED=[deretraction_speed]
RESPOND TYPE=command MSG="Retraction length set to [retraction_length]mm" 
RESPOND TYPE=command MSG="Retract speed set to [retraction_speed]/[deretraction_speed]mm/c"

```

конечный код для **OrcaSliser**:

```
END_PRINT

```

### вы купили зашивку корпуса и теперь провода мешают открывать дверцу.

![](/images/door_lock_screen.png)

Для этого надо поменять ориентацию в файле /usr/data/guppyscreen/guppyscreen.json на 0 и убрать данные о калибровке. 

Перед внесением измененний сделайте резервную копию своего файла!

<details><summary>Вариант №1</summary>

`"display_rotate": 2,` - находим строку и меняем на 0 значение.


`"touch_calibration_coeff"` и удаляем его и все данные за ним до следующего параметра.

перезагружаемся и выполняем калибровку экрана 

</details>

<details><summary>Вариант №2 простой</summary>

В консоль ssh копируем следующие команды. 

```
cd /usr/data/guppyscreen/
mv guppyscreen.json guppyscreen.json.bak
wget -P /usr/data/guppyscreen/ https://raw.githubusercontent.com/Tombraider2006/Ender5Max/refs/heads/main/files/guppyscreen.json
chmod 644 guppyscreen.json

```
Перезагружаемся и проводим калибровку.
</details>

![](/images/door_unlock_screen.png)